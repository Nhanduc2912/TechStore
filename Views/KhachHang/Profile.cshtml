@model TechStore.Models.KhachHang
@{
    ViewData["Title"] = "Hồ sơ cá nhân";
    var taiKhoan = Model?.MaTkNavigation;
}

<div class="container py-5">
    
    <!-- KHU VỰC THÔNG BÁO -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show shadow-sm mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["Warning"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["PassError"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm mb-4" role="alert">
            <i class="bi bi-x-circle-fill me-2"></i> @TempData["PassError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- SIDEBAR MENU TRÁI -->
        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center pt-4 pb-3">
                    <div class="position-relative d-inline-block mb-3">
                        <div class="bg-gearvn text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow" style="width: 80px; height: 80px; font-size: 2rem;">
                            @(Model?.HoTen?.Substring(0, 1).ToUpper() ?? "U")
                        </div>
                        <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-light rounded-circle" title="Online">
                            <span class="visually-hidden">Online</span>
                        </span>
                    </div>
                    <h6 class="fw-bold mb-1 text-truncate">@Model?.HoTen</h6>
                    <p class="text-muted small mb-3"><i class="bi bi-shield-check text-primary"></i> Thành viên</p>
                </div>
                <div class="list-group list-group-flush small fw-bold">
                    @* <a href="#points" class="list-group-item list-group-item-action py-3 border-0" data-bs-toggle="list">
                        <i class="bi bi-coin fs-5 me-2 align-middle text-warning"></i> Điểm tích lũy
                    </a> *@
                    <a href="#address" class="list-group-item list-group-item-action py-3 border-0 active" data-bs-toggle="list">
                        <i class="bi bi-geo-alt fs-5 me-2 align-middle text-info"></i> Sổ địa chỉ
                    </a>
                    <a href="#settings" class="list-group-item list-group-item-action py-3 border-0" data-bs-toggle="list">
                        <i class="bi bi-gear fs-5 me-2 align-middle text-secondary"></i> Cài đặt tài khoản
                    </a>
                    <a href="/KhachHang/DangXuat" class="list-group-item list-group-item-action py-3 border-0 text-danger">
                        <i class="bi bi-box-arrow-right fs-5 me-2 align-middle"></i> Đăng xuất
                    </a>
                </div>
            </div>
        </div>

        <!-- NỘI DUNG PHẢI -->
        <div class="col-md-9">
            <div class="card border-0 shadow-sm" style="min-height: 500px;">
                <div class="card-body p-4">
                    <div class="tab-content">
                        
                        <!-- TAB 1: ĐIỂM TÍCH LŨY -->
                        @* <div class="tab-pane fade" id="points">
                            <h5 class="fw-bold mb-4 pb-2 border-bottom text-uppercase">Điểm thưởng TechStore</h5>
                            <div class="text-center py-5">
                                <div class="display-1 text-warning mb-3"><i class="bi bi-piggy-bank"></i></div>
                                <h2 class="fw-bold text-secondary">@Model?.DiemTichLuy điểm</h2>
                                <p class="text-muted">Tích lũy thêm điểm khi mua hàng để đổi các phần quà hấp dẫn!</p>
                                <a href="/" class="btn btn-outline-warning mt-2">Mua sắm ngay để tích điểm</a>
                            </div>
                        </div> *@

                        <!-- TAB 2: SỔ ĐỊA CHỈ (CẬP NHẬT MỚI: Tích hợp API) -->
                        <div class="tab-pane fade show active" id="address">
                            <h5 class="fw-bold mb-4 pb-2 border-bottom text-uppercase">Cập nhật địa chỉ nhận hàng</h5>
                            
                            <div class="border rounded p-3 mb-4 position-relative bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted d-block">Địa chỉ hiện tại:</small>
                                        <span class="fw-bold text-dark fs-5">@(string.IsNullOrEmpty(Model?.DiaChi) ? "Chưa cập nhật" : Model.DiaChi)</span>
                                    </div>
                                    <span class="badge bg-danger">Mặc định</span>
                                </div>
                            </div>

                            <!-- Form cập nhật địa chỉ với API -->
                            <form asp-action="UpdateAddress" method="post" id="addressForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Tỉnh / Thành <span class="text-danger">*</span></label>
                                        <select class="form-select" id="tinh" name="TinhThanh" required>
                                            <option value="0">-- Chọn Tỉnh --</option>
                                        </select> 
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Quận / Huyện <span class="text-danger">*</span></label>
                                        <select class="form-select" id="quan" name="QuanHuyen" required>
                                            <option value="0">-- Chọn Quận --</option>
                                        </select> 
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Phường / Xã <span class="text-danger">*</span></label>
                                        <select class="form-select" id="phuong" name="PhuongXa" required>
                                            <option value="0">-- Chọn Phường --</option>
                                        </select> 
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Địa chỉ cụ thể (Số nhà, đường...) <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="SoNha" placeholder="Ví dụ: Số 10, Ngõ 50, Đường ABC..." required>
                                    </div>
                                    <div class="col-12 text-end mt-4">
                                        <button type="submit" class="btn btn-primary fw-bold px-4">
                                            <i class="bi bi-save me-2"></i> Lưu địa chỉ mới
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- TAB 3: CÀI ĐẶT (HỒ SƠ & BẢO MẬT) -->
                        <div class="tab-pane fade" id="settings">
                            <h5 class="fw-bold mb-4 pb-2 border-bottom text-uppercase">Cài đặt tài khoản</h5>
                            
                            <!-- Form Cập nhật thông tin cơ bản -->
                            <form asp-action="UpdateProfile" method="post" class="mb-5">
                                <h6 class="fw-bold text-muted text-uppercase small mb-3">Thông tin định danh</h6>
                                <div class="row mb-3 align-items-center">
                                    <label class="col-md-3 col-form-label text-muted text-end">Tên hiển thị</label>
                                    <div class="col-md-9">
                                        <input type="text" name="HoTen" class="form-control" value="@Model?.HoTen" required>
                                    </div>
                                </div>
                                <div class="row mb-3 align-items-center">
                                    <label class="col-md-3 col-form-label text-muted text-end">Ngày sinh</label>
                                    <div class="col-md-9">
                                        <input type="date" name="NgaySinh" class="form-control w-50" value="@(Model?.NgaySinh?.ToString("yyyy-MM-dd"))">
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button type="submit" class="btn btn-sm btn-outline-primary px-3">Lưu hồ sơ</button>
                                </div>
                            </form>

                            <hr class="border-secondary opacity-25">

                            <!-- Khu vực Email & SĐT (Xác thực) -->
                            <h6 class="fw-bold text-muted text-uppercase small mb-3 mt-4">Liên lạc & Xác thực</h6>
                            
                            <div class="row mb-3 align-items-center">
                                <label class="col-md-3 col-form-label text-muted text-end">Email</label>
                                <div class="col-md-9">
                                    <div class="input-group">
                                        <input type="text" id="profileEmail" class="form-control" value="@taiKhoan?.Email" readonly>
                                        @if (taiKhoan?.EmailDaXacThuc == true) {
                                            <span class="input-group-text bg-success text-white border-0 small fw-bold" title="Đã xác thực"><i class="bi bi-check-circle-fill"></i></span>
                                        } else {
                                            <button type="button" class="btn btn-warning fw-bold" onclick="sendOtp('email')">Xác thực</button>
                                        }
                                    </div>
                                    <!-- Ô nhập OTP ẩn -->
                                    <div id="otpInputEmail" class="mt-2 d-none input-group input-group-sm w-75">
                                        <input type="text" id="otpCodeEmail" class="form-control" placeholder="Nhập mã OTP vừa nhận">
                                        <button class="btn btn-primary" onclick="verifyOtp('email')">Gửi</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <label class="col-md-3 col-form-label text-muted text-end">Số điện thoại</label>
                                <div class="col-md-9">
                                    <div class="input-group">
                                        <input type="text" id="profilePhone" class="form-control" value="@taiKhoan?.Sdt" readonly>
                                        @if (taiKhoan?.SDTDaXacThuc == true) {
                                            <span class="input-group-text bg-success text-white border-0 small fw-bold" title="Đã xác thực"><i class="bi bi-check-circle-fill"></i></span>
                                        } else {
                                            <button type="button" class="btn btn-warning fw-bold" onclick="sendOtp('phone')">Xác thực</button>
                                        }
                                    </div>
                                    <div id="otpInputPhone" class="mt-2 d-none input-group input-group-sm w-75">
                                        <input type="text" id="otpCodePhone" class="form-control" placeholder="Nhập mã OTP vừa nhận">
                                        <button class="btn btn-primary" onclick="verifyOtp('phone')">Gửi</button>
                                    </div>
                                </div>
                            </div>

                            <hr class="border-secondary opacity-25">

                            <!-- Đổi mật khẩu -->
                            <h6 class="fw-bold text-muted text-uppercase small mb-3 mt-4">Bảo mật</h6>
                            <div class="row mb-3 align-items-center">
                                <label class="col-md-3 col-form-label text-muted text-end">Mật khẩu</label>
                                <div class="col-md-9 d-flex align-items-center">
                                    <input type="password" class="form-control bg-light me-2" value="********" readonly style="max-width: 200px;">
                                    <button class="btn btn-outline-danger btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePassword">
                                        <i class="bi bi-pencil-square"></i> Đổi mật khẩu
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Form Đổi mật khẩu (Ẩn/Hiện) -->
                            <div class="collapse mt-3" id="collapsePassword">
                                <div class="card card-body bg-light border-0">
                                    <form asp-action="ChangePassword" method="post">
                                        <div class="mb-2">
                                            <label class="form-label small fw-bold">Mật khẩu hiện tại</label>
                                            <input type="password" name="OldPass" class="form-control" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small fw-bold">Mật khẩu mới</label>
                                            <input type="password" name="NewPass" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Xác nhận mật khẩu mới</label>
                                            <input type="password" name="ConfirmPass" class="form-control" required>
                                        </div>
                                        <button type="submit" class="btn btn-danger bg-gearvn w-100">Lưu mật khẩu mới</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS: API ĐỊA CHỈ & OTP -->
<script src="https://esgoo.net/scripts/jquery.js"></script>
<script>
    $(document).ready(function() {
        // --- 1. API ĐỊA CHỈ ---
        $.getJSON('https://esgoo.net/api-tinhthanh/1/0.htm', function(data_tinh) {
            if (data_tinh.error == 0) {
               $.each(data_tinh.data, function (key_tinh, val_tinh) {
                  $("#tinh").append('<option value="' + val_tinh.id + '">' + val_tinh.full_name + '</option>');
               });
               
               $("#tinh").change(function (e) {
                    var idtinh = $(this).val();
                    $("#quan").html('<option value="0">-- Chọn Quận --</option>');
                    $("#phuong").html('<option value="0">-- Chọn Phường --</option>');
                    if(idtinh != "0"){
                        $.getJSON('https://esgoo.net/api-tinhthanh/2/' + idtinh + '.htm', function (data_quan) {
                            if (data_quan.error == 0) {
                               $.each(data_quan.data, function (key_quan, val_quan) {
                                  $("#quan").append('<option value="' + val_quan.id + '">' + val_quan.full_name + '</option>');
                               });
                            }
                        });
                    }
               });
               
               $("#quan").change(function (e) {
                    var idquan = $(this).val();
                    $("#phuong").html('<option value="0">-- Chọn Phường --</option>');
                    if(idquan != "0"){
                        $.getJSON('https://esgoo.net/api-tinhthanh/3/' + idquan + '.htm', function (data_phuong) {
                            if (data_phuong.error == 0) {
                               $.each(data_phuong.data, function (key_phuong, val_phuong) {
                                  $("#phuong").append('<option value="' + val_phuong.full_name + '">' + val_phuong.full_name + '</option>');
                               });
                            }
                        });
                    }
               });
            }
        });
        
        // TRƯỚC KHI SUBMIT ĐỊA CHỈ: Chuyển ID thành TÊN để lưu vào DB
        $('#addressForm').on('submit', function() {
            if($("#tinh").val() != "0") $("#tinh option:selected").val($("#tinh option:selected").text()); 
            if($("#quan").val() != "0") $("#quan option:selected").val($("#quan option:selected").text());
            if($("#phuong").val() != "0") $("#phuong option:selected").val($("#phuong option:selected").text());
        });
    });

    // --- 2. SCRIPT OTP (XÁC THỰC) ---
    function sendOtp(type) {
        var value = (type === 'email') ? $('#profileEmail').val() : $('#profilePhone').val();
        if (!value) { alert("Dữ liệu trống!"); return; }

        $.ajax({
            url: '/KhachHang/SendOtp',
            type: 'POST',
            data: { type: type, value: value },
            success: function (res) {
                alert(res.message);
                if (res.success) {
                    if (type === 'email') $('#otpInputEmail').removeClass('d-none');
                    else $('#otpInputPhone').removeClass('d-none');
                }
            }
        });
    }

    function verifyOtp(type) {
        var value = (type === 'email') ? $('#profileEmail').val() : $('#profilePhone').val();
        var code = (type === 'email') ? $('#otpCodeEmail').val() : $('#otpCodePhone').val();

        $.ajax({
            url: '/KhachHang/VerifyOtp',
            type: 'POST',
            data: { type: type, value: value, code: code },
            success: function (res) {
                alert(res.message);
                if (res.success) {
                    location.reload();
                }
            }
        });
    }
</script>

<style>
    .list-group-item.active {
        background-color: transparent;
        color: var(--gearvn-red);
        border-color: transparent;
        font-weight: bold;
        border-right: 4px solid var(--gearvn-red) !important;
    }
    .list-group-item {
        color: #555;
        transition: 0.2s;
    }
    .list-group-item:hover:not(.active) {
        background-color: #f8f9fa;
        color: var(--gearvn-red);
    }
</style>