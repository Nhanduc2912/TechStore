@using TechStore.Helpers
@using TechStore.ViewModels
@{
    // Lấy giỏ hàng để đếm số lượng
    var cart = Context.Session.Get<List<CartItem>>("MYCART");
    var totalItems = cart != null ? cart.Sum(p => p.SoLuong) : 0;
}

<div class="bg-gearvn py-3 sticky-top shadow-sm">
    <div class="container">
        <div class="row align-items-center">
            <!-- 1. LOGO -->
            <div class="col-md-3 col-6">
                <a class="navbar-brand text-white fw-bold fs-3 d-flex align-items-center gap-2" href="/">
                    <i class="bi bi-pc-display-horizontal"></i> <span>TECHSTORE</span>
                </a>
            </div>

            <!-- 2. THANH TÌM KIẾM -->
            <div class="col-md-5 d-none d-md-block">
                <form class="d-flex search-bar position-relative" asp-controller="HangHoa" asp-action="Search" method="get">
                    <input class="form-control py-2 ps-4 rounded-pill border-0" type="search" name="query" placeholder="Bạn cần tìm linh kiện gì hôm nay?" aria-label="Search">
                    <button class="btn position-absolute end-0 top-0 h-100 px-3 rounded-pill" type="submit">
                        <i class="bi bi-search text-white"></i>
                    </button>
                </form>
            </div>

            <!-- 3. CÁC NÚT CHỨC NĂNG -->
            <div class="col-md-4 col-6 d-flex justify-content-end align-items-center text-white">

                <!-- Hotline -->
                <div class="d-none d-lg-block me-4 text-end">
                    <a href="tel:18006969" class="text-white text-decoration-none d-flex align-items-center gap-2">
                        <i class="bi bi-headset fs-3"></i>
                        <div class="lh-1 text-start">
                            <span class="d-block small opacity-75">Hotline 24/7</span>
                            <span class="fw-bold">1800.6969</span>
                        </div>
                    </a>
                </div>

                <!-- LOGIC TÀI KHOẢN -->
                <div class="me-4 position-relative">
                    @if (Context.Session.GetString("MaKh") != null)
                    {
                        // TRƯỜNG HỢP 1: ĐÃ ĐĂNG NHẬP -> Hiện tên & Menu Dropdown
                        <div class="dropdown">
                            <a href="#" class="text-white text-decoration-none d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                                <div class="bg-white text-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                    <i class="bi bi-person-fill fs-5"></i>
                                </div>
                                <div class="d-none d-xl-block lh-1 text-start">
                                    <span class="d-block small opacity-75">Xin chào,</span>
                                    <span class="fw-bold" style="max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                                        @Context.Session.GetString("HoTen")
                                    </span>
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2">
                                <!-- ĐÃ CẬP NHẬT LINK: HỒ SƠ CÁ NHÂN -->
                                <li><a class="dropdown-item" href="/KhachHang/Profile"><i class="bi bi-person me-2"></i>Hồ sơ cá nhân</a></li>

                                <!-- ĐÃ CẬP NHẬT LINK: ĐƠN MUA -->
                                <li><a class="dropdown-item" href="/KhachHang/DonHang"><i class="bi bi-box-seam me-2"></i>Đơn mua</a></li>

                                <!-- Menu Admin (Chỉ hiện nếu vai trò là Admin) -->
                                @if (Context.Session.GetString("VaiTro") == "Admin")
                                {
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item fw-bold text-primary" href="/Admin/HomeAdmin"><i class="bi bi-speedometer2 me-2"></i>Trang quản trị</a></li>
                                }

                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/KhachHang/DangXuat"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                            </ul>
                        </div>
                    }
                    else
                    {
                        // TRƯỜNG HỢP 2: CHƯA ĐĂNG NHẬP -> Hiện nút bấm mở Modal Đăng nhập
                        <a href="#" class="text-white text-decoration-none d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="bi bi-person-circle fs-2"></i>
                            <div class="d-none d-xl-block lh-1 text-start">
                                <span class="d-block small opacity-75">Tài khoản</span>
                                <span class="fw-bold">Đăng nhập</span>
                            </div>
                        </a>
                    }
                </div>

                <!-- GIỎ HÀNG -->
                <a href="/GioHang" class="text-white text-decoration-none position-relative d-flex align-items-center gap-2">
                    <div class="position-relative">
                        <i class="bi bi-cart3 fs-3"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark border border-white">
                            @totalItems <!-- Hiển thị số lượng động -->
                        </span>
                    </div>
                    <span class="d-none d-xl-block fw-bold small">Giỏ<br>hàng</span>
                </a>
            </div>
        </div>
    </div>
</div>