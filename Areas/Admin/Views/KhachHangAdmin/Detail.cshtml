@model TechStore.Models.KhachHang
@{
    ViewData["Title"] = "Chi tiết khách hàng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var taiKhoan = Model.MaTkNavigation;
}

<div class="page-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <a href="/Admin/KhachHang" class="btn btn-outline-secondary me-3"><i class="bi bi-arrow-left"></i> Quay lại</a>
        <div>
            <h3 class="mb-0 fw-bold">Khách hàng: @Model.HoTen</h3>
            <small class="text-muted">Mã KH: #@Model.MaKh</small>
        </div>
    </div>
    <div class="btn-group">
        <a href="/Admin/KhachHang/EditNote/@Model.MaKh" class="btn btn-warning"><i class="bi bi-pencil-square me-1"></i> Ghi chú</a>
        @if (taiKhoan?.TrangThai == true)
        {
            <button class="btn btn-danger" onclick="lockUser(@Model.MaKh)"><i class="bi bi-lock-fill me-1"></i> Khóa tài khoản</button>
        }
        else if (taiKhoan != null)
        {
            <button class="btn btn-success" onclick="unlockUser(@Model.MaKh)"><i class="bi bi-unlock-fill me-1"></i> Mở khóa</button>
        }
    </div>
</div>

<!-- ALERTS -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="bi bi-check-circle me-2"></i> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <!-- CỘT TRÁI: THÔNG TIN CÁ NHÂN -->
    <div class="col-md-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white fw-bold py-3">
                <i class="bi bi-person-badge me-2 text-primary"></i> Thông tin cá nhân
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 80px; height: 80px;">
                        <span class="fs-1 fw-bold text-secondary">@(Model.HoTen?.Substring(0, 1).ToUpper() ?? "U")</span>
                    </div>
                    <h5 class="fw-bold">@Model.HoTen</h5>
                    <span class="badge @(taiKhoan?.TrangThai == true ? "bg-success" : "bg-danger")">
                        @(taiKhoan?.TrangThai == true ? "Đang hoạt động" : "Đã bị khóa")
                    </span>
                </div>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Ngày sinh:</span>
                        <span class="fw-bold">@(Model.NgaySinh?.ToString("dd/MM/yyyy") ?? "Chưa cập nhật")</span>
                    </li>
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Email:</span>
                        <span class="fw-bold text-break" style="max-width: 200px;">@(taiKhoan?.Email ?? "N/A")</span>
                    </li>
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">SĐT:</span>
                        <span class="fw-bold">@(taiKhoan?.Sdt ?? "N/A")</span>
                    </li>
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Địa chỉ:</span>
                        <span class="fw-bold text-end" style="max-width: 200px;">@(Model.DiaChi ?? "Chưa cập nhật")</span>
                    </li>
                </ul>

                <h6 class="mt-4 mb-3 fw-bold text-muted text-uppercase small">Bảo mật & Hệ thống</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Tên đăng nhập:</span>
                        <span class="fw-bold">@(taiKhoan?.TenDangNhap ?? "N/A")</span>
                    </li>
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Ngày tham gia:</span>
                        <span>@(taiKhoan?.NgayTao?.ToString("dd/MM/yyyy HH:mm") ?? "-")</span>
                    </li>
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Đăng nhập cuối:</span>
                        <span class="text-primary">@(taiKhoan?.LanDangNhapCuoi?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa đăng nhập")</span>
                    </li>
                     <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Xác thực Email:</span>
                        @if(taiKhoan?.EmailDaXacThuc == true) 
                        { <span class="text-success"><i class="bi bi-check-circle-fill"></i> Đã xác thực</span> }
                        else { <span class="text-warning"><i class="bi bi-exclamation-circle"></i> Chưa</span> }
                    </li>
                    <li class="list-group-item px-0 d-flex justify-content-between">
                        <span class="text-muted">Xác thực SĐT:</span>
                        @if(taiKhoan?.SDTDaXacThuc == true) 
                        { <span class="text-success"><i class="bi bi-check-circle-fill"></i> Đã xác thực</span> }
                        else { <span class="text-warning"><i class="bi bi-exclamation-circle"></i> Chưa</span> }
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- CỘT PHẢI: THỐNG KÊ & ĐƠN HÀNG -->
    <div class="col-md-8 mb-4">
        <!-- Thẻ Thống kê -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <div class="fs-1 mb-2"><i class="bi bi-cart4"></i></div>
                        <h3 class="fw-bold">@ViewBag.TongDonHang</h3>
                        <div class="small opacity-75">Tổng đơn hàng</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm bg-success text-white h-100">
                    <div class="card-body text-center">
                        <div class="fs-1 mb-2"><i class="bi bi-cash-coin"></i></div>
                        <h3 class="fw-bold">@((ViewBag.TongTienMua ?? 0).ToString("#,##0"))₫</h3>
                        <div class="small opacity-75">Tổng chi tiêu</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm bg-warning text-dark h-100">
                    <div class="card-body text-center">
                        <div class="fs-1 mb-2"><i class="bi bi-gem"></i></div>
                        <h3 class="fw-bold">@(Model.DiemTichLuy ?? 0)</h3>
                        <div class="small opacity-75">Điểm tích lũy</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách đơn hàng -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-receipt me-2 text-secondary"></i>Lịch sử mua hàng</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Mã ĐH</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th class="text-end pe-4">Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.HoaDons != null && Model.HoaDons.Any())
                            {
                                @foreach (var dh in Model.HoaDons.OrderByDescending(h => h.NgayDat))
                                {
                                    // Tính lại tổng tiền từng đơn để hiển thị (nếu chưa có cột TongTien trong HoaDon)
                                    var total = dh.ChiTietHoaDons?.Sum(ct => ct.DonGia * ct.SoLuong) ?? 0;
                                    
                                    <tr>
                                        <td class="ps-4 fw-bold text-primary">#@dh.MaHd</td>
                                        <td>@dh.NgayDat?.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td class="fw-bold text-danger">@total.ToString("#,##0")₫</td>
                                        <td>
                                            @{
                                                var badgeClass = dh.MaTrangThai switch {
                                                    0 => "bg-warning text-dark",
                                                    1 => "bg-info",
                                                    2 => "bg-primary",
                                                    3 => "bg-success",
                                                    -1 => "bg-secondary",
                                                    _ => "bg-light text-dark"
                                                };
                                                // Cần include MaTrangThaiNavigation ở Controller để hiện tên, tạm thời hiện mã nếu null
                                            }
                                            <span class="badge @badgeClass">
                                                 @(dh.MaTrangThai == 0 ? "Mới đặt" : 
                                                   dh.MaTrangThai == 1 ? "Đã duyệt" :
                                                   dh.MaTrangThai == 2 ? "Đang giao" :
                                                   dh.MaTrangThai == 3 ? "Hoàn thành" :
                                                   dh.MaTrangThai == -1 ? "Đã hủy" : "Khác")
                                            </span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <a href="/Admin/DonHang/Detail/@dh.MaHd" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i></a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-center py-4 text-muted">Khách hàng này chưa có đơn hàng nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function lockUser(id) {
            if(confirm('Bạn có chắc muốn KHÓA tài khoản này không? Khách hàng sẽ không thể đăng nhập.')) {
                $.post('/Admin/KhachHang/Lock/' + id, function(res){
                    if(res.success) location.reload();
                    else alert(res.message);
                });
            }
        }
        function unlockUser(id) {
             if(confirm('Bạn có chắc muốn MỞ KHÓA tài khoản này?')) {
                $.post('/Admin/KhachHang/Unlock/' + id, function(res){
                    if(res.success) location.reload();
                    else alert(res.message);
                });
            }
        }
    </script>
}